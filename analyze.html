<!DOCTYPE html>
<html lang="vi">
<head>
<meta charset="UTF-8">
<title>AI H∆∞·ªõng nghi·ªáp</title>
<meta name="viewport" content="width=device-width, initial-scale=1.0">

<style>
:root{
  --bg:#f5f7fb;
  --panel:#ffffff;
  --bubble-ai:#f1f5f9;
  --bubble-user:#2563eb;
  --border:#e5e7eb;
  --text:#0f172a;
  --muted:#64748b;
  --accent:#2563eb;
}

*{box-sizing:border-box}

body{
  margin:0;
  background:var(--bg);
  color:var(--text);
  font-family:system-ui,-apple-system,Segoe UI,Roboto;
}

/* ===== LAYOUT ===== */
.app{
  display:flex;
  flex-direction:column;
  height:100vh;
}

.header{
  padding:16px 20px;
  border-bottom:1px solid var(--border);
  background:var(--panel);
}

.header h1{
  margin:0;
  font-size:18px;
  font-weight:600;
}

.status{
  font-size:13px;
  color:var(--muted);
}

/* ===== CHAT ===== */
.chat{
  flex:1;
  overflow-y:auto;
  padding:24px;
  display:flex;
  flex-direction:column;
  gap:18px;
}

.msg{
  max-width:800px;
  padding:16px 18px;
  border-radius:14px;
  line-height:1.7;
  font-size:14.5px;
  animation:fadeUp .25s ease;
}

.ai{
  align-self:flex-start;
  background:var(--bubble-ai);
  border:1px solid var(--border);
}

.user{
  align-self:flex-end;
  background:var(--bubble-user);
  color:white;
}

/* ===== MARKDOWN ===== */
.msg h3{margin:12px 0 6px;font-size:16px}
.msg ul{margin:6px 0;padding-left:18px}
.msg li{margin:4px 0}
.msg b{font-weight:600}

/* ===== INPUT ===== */
.input-area{
  border-top:1px solid var(--border);
  background:var(--panel);
  padding:14px;
  display:flex;
  gap:12px;
}

textarea{
  flex:1;
  resize:none;
  padding:12px 14px;
  border-radius:10px;
  border:1px solid var(--border);
  background:white;
  color:var(--text);
  font-size:14px;
}

textarea::placeholder{color:var(--muted)}

button{
  padding:0 18px;
  border-radius:10px;
  border:none;
  cursor:pointer;
  font-weight:600;
  background:var(--accent);
  color:white;
}

button:hover{opacity:.9}

/* ===== FOOTER ===== */
.actions{
  display:flex;
  justify-content:center;
  gap:12px;
  padding:10px;
}

.actions button{
  background:white;
  color:var(--muted);
  border:1px solid var(--border);
}

/* ===== LOADING DOTS ===== */
.dots::after{
  content:"";
  animation:dots 1.4s infinite;
}

@keyframes dots{
  0%{content:""}
  33%{content:"."}
  66%{content:".."}
  100%{content:"..."}
}

/* ===== ANIMATION ===== */
@keyframes fadeUp{
  from{opacity:0;transform:translateY(6px)}
  to{opacity:1;transform:none}
}
</style>
</head>

<body>
<div class="app">

  <div class="header">
    <h1>üéì AI T∆∞ v·∫•n H∆∞·ªõng nghi·ªáp</h1>
    <div id="status" class="status">ƒêang chu·∫©n b·ªã ph√¢n t√≠ch‚Ä¶</div>
  </div>

  <div id="chat" class="chat"></div>

  <div class="input-area">
    <textarea id="input" rows="2"
      placeholder="Nh·∫≠p c√¢u h·ªèi c·ªßa b·∫°n‚Ä¶"></textarea>
    <button onclick="sendChat()">G·ª≠i</button>
  </div>

  <div class="actions">
    <button onclick="back()">‚¨Ö Quay l·∫°i</button>
    <button onclick="resetAll()">üßπ Reset</button>
  </div>

</div>

<script>
"use strict";

/* ================= CONFIG (GI·ªÆ NGUY√äN LOGIC) ================= */

const STORAGE_KEY = "ai_huong_nghiep_student";
const CHAT_CACHE_KEY = "ai_huong_nghiep_chat_cache";


let student = null;
let conversationText = "";

/* ================= PROMPT BUILDER (GI·ªÆ NGUY√äN) ================= */

function buildGeminiPrompt(student){
  return `
B·∫°n l√† C·ªê V·∫§N H∆Ø·ªöNG NGHI·ªÜP cho h·ªçc sinh l·ªõp 12 Vi·ªát Nam.

Y√äU C·∫¶U VAI TR√í:
- Vi·∫øt nh∆∞ m·ªôt th·∫ßy/c√¥ t∆∞ v·∫•n h∆∞·ªõng nghi·ªáp
- Gi·∫£i th√≠ch r√µ r√†ng, d·ªÖ hi·ªÉu
- Kh√¥ng ph√°n x√©t, kh√¥ng ch√™ tr√°ch
- Kh√¥ng nh·∫Øc l·∫°i ho·∫∑c l·∫∑p l·∫°i t·ª´ ng·ªØ ti√™u c·ª±c xu·∫•t hi·ªán trong d·ªØ li·ªáu
- Kh√¥ng d√πng thu·∫≠t ng·ªØ h·ªçc thu·∫≠t kh√≥ hi·ªÉu n·∫øu kh√¥ng c·∫ßn thi·∫øt

M·ª§C TI√äU:
Gi√∫p h·ªçc sinh:
1. Hi·ªÉu r√µ xu h∆∞·ªõng h·ªçc t·∫≠p v√† c√°ch t∆∞ duy c·ªßa b·∫£n th√¢n
2. Hi·ªÉu v√¨ sao m√¨nh ph√π h·ª£p v·ªõi m·ªôt s·ªë nh√≥m ng√†nh nh·∫•t ƒë·ªãnh
3. C√≥ ƒë·ªãnh h∆∞·ªõng h·ªçc t·∫≠p c·ª• th·ªÉ, kh√¥ng m∆° h·ªì
4. C·∫£m th·∫•y y√™n t√¢m h∆°n khi ƒë·ª©ng tr∆∞·ªõc l·ª±a ch·ªçn ng√†nh ngh·ªÅ

========================
TH√îNG TIN H·ªåC SINH

H·ªç t√™n: ${student.basicInfo.name}

--- S·ªû TH√çCH & C√ÅCH H·ªåC ---
- S·ªü th√≠ch n·ªïi b·∫≠t: ${student.preferences.interests?.join(", ") || "Ch∆∞a r√µ"}
- C√°ch h·ªçc hi·ªáu qu·∫£: ${student.preferences.learningStyle}
- M√¥i tr∆∞·ªùng l√†m vi·ªác mong mu·ªën: ${student.preferences.workStyle}
- Kh√≥ khƒÉn khi h·ªçc: ${student.preferences.studyPain || "Kh√¥ng n√™u"}

--- T·ª∞ ƒê√ÅNH GI√Å ---
- T√≠nh c√°ch: ${student.selfAssessment.personality}
- ƒê·∫∑c ƒëi·ªÉm c√° nh√¢n: ${student.selfAssessment.traits?.join(", ") || "Kh√¥ng r√µ"}
- ƒêi·ªÉm m·∫°nh t·ª± nh·∫≠n th·∫•y: ${student.selfAssessment.strengths}
- H·∫°n ch·∫ø ƒëang g·∫∑p ph·∫£i: ${student.selfAssessment.weaknesses}
- ƒêi·ªÅu lo l·∫Øng khi ch·ªçn ng√†nh: ${student.selfAssessment.careerFear || "Kh√¥ng n√™u"}

--- ƒêA TR√ç TU·ªÜ (MI) ---
${student.MI.answers.map((a,i)=>`${i+1}. ${a.question}\n‚Üí ${a.selected}`).join("\n\n")}

T·ªïng MI:
Logic ${student.MI.score.logic},
Ng√¥n ng·ªØ ${student.MI.score.language},
Kh√¥ng gian ${student.MI.score.visual},
K·ªπ thu·∫≠t ${student.MI.score.tech}

--- HOLLAND ---
R ${student.holland.score.R}, I ${student.holland.score.I}, A ${student.holland.score.A},
S ${student.holland.score.S}, E ${student.holland.score.E}, C ${student.holland.score.C}

--- SWOT ---
- ƒêi·ªÉm m·∫°nh: ${student.SWOT.strengths}
- H·∫°n ch·∫ø: ${student.SWOT.weaknesses}
- C∆° h·ªôi: ${student.SWOT.opportunities}
- Th√°ch th·ª©c: ${student.SWOT.threats}

========================
Y√äU C·∫¶U TR·∫¢ L·ªúI:
1. Nh·∫≠n x√©t t·ªïng quan
2. Ph√¢n t√≠ch ƒëi·ªÉm m·∫°nh
3. G·ª£i √Ω 2‚Äì4 nh√≥m ng√†nh
4. Ng√†nh c·ª• th·ªÉ
5. L·ªô tr√¨nh l·ªõp 12
6. L·ªùi khuy√™n th·ª±c t·∫ø
`;
}

/* ================= HELPERS ================= */

const $ = id => document.getElementById(id);

function md(text){
  return text
    .replace(/\*\*(.*?)\*\*/g,"<b>$1</b>")
    .replace(/^### (.*$)/gim,"<h3>$1</h3>")
    .replace(/\n- (.*)/g,"<li>$1</li>")
    .replace(/(<li>.*<\/li>)/gs,"<ul>$1</ul>")
    .replace(/\n/g,"<br>");
}

function addMsg(role, html){
  const d = document.createElement("div");
  d.className = "msg " + role;
  d.innerHTML = html;
  $("chat").appendChild(d);
  $("chat").scrollTop = $("chat").scrollHeight;
}

/* ================= TYPING INDICATOR ================= */

function showTyping(){
  const d = document.createElement("div");
  d.className = "msg ai";
  d.id = "typing";
  d.innerHTML = "<i>AI ƒëang suy nghƒ©<span class='dots'></span></i>";
  $("chat").appendChild(d);
  $("chat").scrollTop = $("chat").scrollHeight;
}

function hideTyping(){
  const t = $("typing");
  if(t) t.remove();
}

/* ================= STREAMING (ADAPTIVE) ================= */

async function streamText(fullText){
  const d = document.createElement("div");
  d.className = "msg ai";
  $("chat").appendChild(d);

  const len = fullText.length;
  let step = 2, speed = 20;

  if(len > 800){ step = 6; speed = 14; }
  else if(len > 400){ step = 5; speed = 16; }
  else if(len > 200){ step = 4; speed = 18; }

  let i = 0;

  const timer = setInterval(()=>{
    const progress = i / len;
    let dynamicStep = step;

    if(progress > 0.7) dynamicStep = Math.max(1, step - 2);
    if(progress > 0.9) dynamicStep = 1;

    i += dynamicStep;
    d.innerHTML = md(fullText.slice(0, i));
    $("chat").scrollTop = $("chat").scrollHeight;

    if(i >= len){
      clearInterval(timer);
      d.innerHTML = md(fullText);
      saveChatCache();
    }
  }, speed);
}

/* ================= GEMINI ================= */

async function fetchGemini(prompt){
  showTyping();
  $("status").textContent = "AI ƒëang ph√¢n t√≠ch‚Ä¶";

  const res = await fetch("/api/gemini", {
    method: "POST",
    headers: { "Content-Type": "application/json" },
    body: JSON.stringify({ prompt })
  });

  const data = await res.json();
  hideTyping();

  return data.text || "AI kh√¥ng ph·∫£n h·ªìi.";
}


/* ================= CHAT CACHE ================= */

function saveChatCache(){
  localStorage.setItem(CHAT_CACHE_KEY, JSON.stringify({
    conversationText,
    chatHTML: $("chat").innerHTML
  }));
}

function restoreChatCache(){
  const raw = localStorage.getItem(CHAT_CACHE_KEY);
  if(!raw) return false;

  try{
    const data = JSON.parse(raw);
    conversationText = data.conversationText || "";
    $("chat").innerHTML = data.chatHTML || "";
    $("chat").scrollTop = $("chat").scrollHeight;
    $("status").textContent = "ƒê√£ kh√¥i ph·ª•c cu·ªôc tr√≤ chuy·ªán";
    return true;
  }catch{
    return false;
  }
}

/* ================= FLOW ================= */

function loadStudent(){
  const raw = localStorage.getItem(STORAGE_KEY);
  if(!raw){
    location.href="index.html";
    return false;
  }
  student = JSON.parse(raw);
  return true;
}

async function analyze(){
  conversationText = buildGeminiPrompt(student);
  const res = await fetchGemini(conversationText);
  conversationText += "\n\nAI:\n" + res;
  $("status").textContent = "Ho√†n t·∫•t";
  streamText(res);
}

async function sendChat(){
  const q = $("input").value.trim();
  if(!q) return;

  $("input").value="";
  addMsg("user", md(q));

  conversationText += "\n\nH·ªçc sinh h·ªèi:\n" + q;
  const r = await fetchGemini(conversationText);
  conversationText += "\n\nAI:\n" + r;
  $("status").textContent = "S·∫µn s√†ng";
  streamText(r);
}

function back(){ location.href="index.html"; }

function resetAll(){
  localStorage.removeItem(STORAGE_KEY);
  localStorage.removeItem(CHAT_CACHE_KEY);
  location.href="index.html";
}

/* ================= INIT ================= */

window.onload = ()=>{
  if(!loadStudent()) return;

  if(!restoreChatCache()){
    analyze(); // ch·ªâ g·ªçi Gemini khi CH∆ØA c√≥ cache
  }
};
</script>

</body>
</html>


